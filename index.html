<!--
ã€Šåå¹´é€€ä¼‘ã€‹â€” Runner å¹³å°æ¨¡æ“¬å™¨ï¼ˆä¸­æ–‡è®Šé«”ï½œå·²ä¿®æ­£ï¼šæ”¯å‡º$20k + äº‹ä»¶å†·å» + Runner ä¸Šé™/éæ¸› + Burnout/Health é‡ç½° + å´©ç›¤æ‰Runner + ä¼‘æ¯å›è¡€ + contingency æ³¢å‹•ï¼‰

ç”¨æ³•ï¼š
- å­˜æˆ index.html
- ç›´æ¥é–‹ï¼ˆæˆ–æ”¾ GitHub Pagesï¼‰

GitHub Pagesï¼š
1) repo æ ¹ç›®éŒ„æ”¾ index.html
2) Settings â†’ Pages â†’ Deploy from branch â†’ main / root
-->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åå¹´é€€ä¼‘ â€” Runner å¹³å°æ¨¡æ“¬å™¨ï¼ˆä¸­æ–‡ï¼‰</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", Segoe UI, Roboto, Arial; margin: 0; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
    h1 { margin: 6px 0 6px; font-size: 22px; }
    .sub { opacity: .82; margin: 0 0 14px; line-height: 1.5; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 980px) { .grid { grid-template-columns: 1.2fr .8fr; } }
    .card { border: 1px solid rgba(127,127,127,.25); border-radius: 14px; padding: 14px; background: rgba(127,127,127,.05); }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .sep { height: 1px; background: rgba(127,127,127,.25); margin: 10px 0; }
    .pill { font-size: 12px; border: 1px solid rgba(127,127,127,.35); padding: 4px 8px; border-radius: 999px; opacity: .9; }
    .muted { opacity: .75; }
    .kpi { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
    @media (min-width: 760px) { .kpi { grid-template-columns: repeat(4, minmax(0,1fr)); } }
    .k { font-size: 12px; opacity: .75; }
    .v { font-size: 16px; font-weight: 800; }
    .bar { height: 10px; border-radius: 999px; background: rgba(127,127,127,.25); overflow: hidden; width: 230px; }
    .bar > div { height: 100%; background: rgba(80,180,120,.85); width: 50%; }
    .bar.red > div { background: rgba(220,90,90,.88); }
    label { font-size: 12px; opacity: .85; display: block; margin-bottom: 4px; }
    input[type="number"], input[type="range"] { width: 100%; }
    input[type="number"] { padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(127,127,127,.35); background: transparent; }
    .two { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 760px) { .two { grid-template-columns: 1fr 1fr; } }
    button { padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(127,127,127,.35); background: rgba(127,127,127,.12); cursor: pointer; font-weight: 800; }
    button.primary { background: rgba(90,160,240,.25); }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; white-space: pre-wrap; line-height: 1.45; }
    .hint { font-size: 12px; opacity: .8; line-height: 1.4; }
    .mini { font-size: 12px; opacity: .85; }
    .btnrow button { padding: 7px 10px; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>åå¹´é€€ä¼‘ â€” Runner å¹³å°æ¨¡æ“¬å™¨ï¼ˆä¸­æ–‡è®Šé«”ï½œä¿®æ­£ç‰ˆï¼‰</h1>
    <p class="sub">
      å…©é–€ç”Ÿæ„ï¼š<b>ä¸»æ¥­ï¼ˆå‚µå‹™/åˆè¦æœå‹™åˆ†ç™¼å¹³å°ï¼‰</b> + <b>å‰µä½œIPï¼ˆæˆæ¬Š/é•·å°¾ï¼‰</b>ã€‚<br/>
      æœ‰ Runner åé¡åˆ¶ã€ç®¡ç†è²»ã€contingency åˆ†æˆï¼›ç¬¬ 4 å¹´å¾Œå¯è³£ä¸»æ¥­è‚¡æ¬Šï¼ˆ10/20/30%ï¼‰ã€‚<br/>
      <b>å¹´æ”¯å‡ºå›ºå®š $20,000</b>ï¼ˆä½ è¦æ±‚ï¼‰ï¼›Burnout/Health æœƒçœŸå¯¦æ‹–æ­»ç”¢èƒ½ï¼ˆå·²åŠ é‡ç½°å‰‡ï¼‰ã€‚
    </p>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div class="row">
            <span class="pill" id="yearPill">ç¬¬ 1 å¹´ / 10 å¹´</span>
            <span class="pill" id="statusPill">é€²è¡Œä¸­</span>
            <span class="pill" id="runnerPill">Runnerï¼š0 äºº</span>
          </div>
          <div class="row">
            <button id="btnReset">é‡é–‹</button>
            <button class="primary" id="btnNext">ä¸‹ä¸€å¹´ â–¶</button>
          </div>
        </div>

        <div class="sep"></div>

        <div class="kpi">
          <div>
            <div class="k">ç¾é‡‘ï¼ˆCashï¼‰</div>
            <div class="v" id="cashV">$0</div>
          </div>
          <div>
            <div class="k">å¹´æ”¯å‡ºï¼ˆExpensesï¼‰</div>
            <div class="v" id="expV">$0</div>
          </div>
          <div>
            <div class="k">ä¸»å‹•ç¾é‡‘æµï¼ˆActive/yrï¼‰</div>
            <div class="v" id="activeV">$0</div>
          </div>
          <div>
            <div class="k">è¢«å‹•æ”¶å…¥ï¼ˆPassive/yrï¼‰</div>
            <div class="v" id="passiveV">$0</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div>
            <div class="k">Burnout</div>
            <div class="row">
              <div class="bar red"><div id="burnBar"></div></div>
              <span class="pill" id="burnV">0/100</span>
            </div>
          </div>
          <div>
            <div class="k">å¥åº·ï¼ˆHealthï¼‰</div>
            <div class="row">
              <div class="bar"><div id="healthBar"></div></div>
              <span class="pill" id="healthV">0/100</span>
            </div>
          </div>
          <div>
            <div class="k">è‚¡ç¥¨è³‡ç”¢ï¼ˆStocksï¼‰</div>
            <div class="v" id="stocksV">$0</div>
            <div class="muted" id="stocksR">ä»Šå¹´å›å ±ï¼š0%</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="two">
          <div class="card">
            <div class="row" style="justify-content:space-between;">
              <b>ä¸»æ¥­å¹³å°ï¼ˆRegulated Platformï¼‰</b>
              <span class="pill" id="rpMeta">ç­‰ç´š 0 â€¢ SOP 0 â€¢ é¢¨éšª 0</span>
            </div>
            <div class="row">
              <div>
                <div class="k">æˆäº¤æ•¸ï¼ˆCases/yrï¼‰</div>
                <div class="v" id="rpCases">0</div>
              </div>
              <div>
                <div class="k">ç®¡ç†è²»æ”¶å…¥ï¼ˆMgmt/yrï¼‰</div>
                <div class="v" id="rpMgmt">$0</div>
              </div>
              <div>
                <div class="k">Contingencyï¼ˆä½ åˆ†æˆ/yrï¼‰</div>
                <div class="v" id="rpCont">$0</div>
              </div>
            </div>
            <div class="mini muted" id="rpRates"></div>
          </div>

          <div class="card">
            <div class="row" style="justify-content:space-between;">
              <b>å‰µä½œIPï¼ˆCreative IPï¼‰</b>
              <span class="pill" id="ciMeta">ç­‰ç´š 0 â€¢ Library 0 â€¢ é¢¨éšª 0</span>
            </div>
            <div class="row">
              <div>
                <div class="k">æˆæ¬Šæ”¶å…¥ï¼ˆActive/yrï¼‰</div>
                <div class="v" id="ciCF">$0</div>
              </div>
              <div>
                <div class="k">è¢«å‹•æˆæ¬Šï¼ˆPassive/yrï¼‰</div>
                <div class="v" id="ciP">$0</div>
              </div>
            </div>
            <div class="mini muted" id="ciNotes"></div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="card">
          <b>å¹´åº¦æ±ºç­–ï¼ˆæ¯ä¸€å¹´ï¼‰</b>
          <p class="hint">
            ä½ æœ‰ <b>ç²¾åŠ› 100</b>ï¼šä¸»æ¥­ / å‰µä½œ / ç³»çµ±åŒ–ï¼ˆSOP/AIï¼‰ã€‚<br/>
            <b>ç³»çµ±åŒ– eSys è¶…é 40 çš„éƒ¨åˆ†ï¼ä¼‘æ¯</b>ï¼ˆå¯å›è¡€ã€é™ burnoutï¼‰ã€‚
          </p>

          <div class="two">
            <div>
              <label>ç²¾åŠ› â†’ ä¸»æ¥­å¹³å°ï¼š<span id="eRegLbl">55</span></label>
              <input id="eReg" type="range" min="0" max="100" value="55" />
            </div>
            <div>
              <label>ç²¾åŠ› â†’ å‰µä½œIPï¼š<span id="eCreLbl">25</span></label>
              <input id="eCre" type="range" min="0" max="100" value="25" />
            </div>
          </div>

          <div class="two" style="margin-top:10px;">
            <div>
              <label>ç²¾åŠ› â†’ ç³»çµ±åŒ–ï¼ˆSOP/AIï¼‰ï¼š<span id="eSysLbl">20</span></label>
              <input id="eSys" type="range" min="0" max="100" value="20" />
            </div>
            <div class="hint">
              <span class="pill">æç¤º</span>
              <span class="muted">ä¸‰è€…ç¸½å’Œè‡ªå‹•é–åœ¨ 100ã€‚</span>
            </div>
          </div>

          <div class="sep"></div>

          <div class="two">
            <div>
              <label>ç¾é‡‘æŠ•å…¥ â†’ ä¸»æ¥­ï¼ˆè¡ŒéŠ·/æ‹›å‹Ÿ/è¨“ç·´ï¼‰</label>
              <input id="cReg" type="number" min="0" step="1000" value="12000" />
            </div>
            <div>
              <label>ç¾é‡‘æŠ•å…¥ â†’ å‰µä½œï¼ˆä½œå“åº«/æˆæ¬Šç®¡é“ï¼‰</label>
              <input id="cCre" type="number" min="0" step="1000" value="6000" />
            </div>
          </div>

          <div class="two" style="margin-top:10px;">
            <div>
              <label>ç¾é‡‘æŠ•å…¥ â†’ è‚¡ç¥¨ï¼ˆè¢«å‹•è³‡ç”¢ï¼‰</label>
              <input id="cStk" type="number" min="0" step="1000" value="7000" />
            </div>
            <div>
              <label>æ‹›å‹Ÿ Runnerï¼ˆæ¯å¹´å¯æ–°å¢ 0â€“3 äººï½œç¡¬ä¸Šé™ 12ï¼‰</label>
              <input id="addRunner" type="number" min="0" max="3" step="1" value="1" />
              <div class="muted mini">>6 Runner é–‹å§‹é‚Šéš›éæ¸›ï¼›Burnout â‰¥ 90 æœƒè‡ªå‹•æµå¤± Runnerã€‚</div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="two">
            <div>
              <label>Runner æ”¶è²»è¨­å®šï¼ˆä½ å¯èª¿ï¼‰</label>
              <div class="two">
                <div>
                  <label>ç®¡ç†è²»ï¼ˆæ¯ Runner / æœˆï¼‰</label>
                  <input id="mgmtFee" type="number" min="0" step="50" value="400" />
                </div>
                <div>
                  <label>æ¯ Runner å¹´åé¡ï¼ˆspots / yrï¼‰</label>
                  <input id="spots" type="number" min="1" max="24" step="1" value="10" />
                </div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div>
                  <label>æ¯å–®åˆå§‹è²»ï¼ˆInitial Feeï¼‰</label>
                  <input id="initialFee" type="number" min="0" step="100" value="1500" />
                </div>
                <div>
                  <label>ä½ å¾ contingency åˆ†æˆï¼ˆ0â€“1ï¼‰</label>
                  <input id="contShare" type="number" min="0" max="1" step="0.05" value="0.33" />
                </div>
              </div>
            </div>

            <div>
              <label>ç¬¬ 4 å¹´å¾Œï¼šå¯å‡ºå”®ä¸»æ¥­è‚¡æ¬Šï¼ˆå¥—ç¾ï¼‰</label>
              <div class="row btnrow">
                <button id="sell0" class="pill">0%</button>
                <button id="sell10" class="pill">10%</button>
                <button id="sell20" class="pill">20%</button>
                <button id="sell30" class="pill">30%</button>
                <span class="muted" id="sellNote">æœªé–‹æ”¾</span>
              </div>
              <div class="muted mini">
                è³£è‚¡æ¬Šï¼ä¸€æ¬¡æ€§å¥—ç¾ï¼Œä½†æœªä¾†ä¸»æ¥­æ”¶å…¥æœƒæŒ‰æ¯”ä¾‹ä¸‹é™ï¼ˆç°¡åŒ–ï¼‰ã€‚
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row" style="justify-content:space-between;">
            <span class="muted" id="guardNote"></span>
            <button class="primary" id="btnApply">å¥—ç”¨ä¸¦é€²å…¥ä¸‹ä¸€å¹´ â–¶</button>
          </div>
        </div>
      </div>

      <div class="card">
        <b>äº‹ä»¶ & å¹´åº¦ç´€éŒ„</b>
        <div class="sep"></div>
        <div class="log" id="log"></div>
      </div>
    </div>
  </div>

<script>
  // ---------- Utility ----------
  const YEARS = 10;
  const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
  const money = (n) => "$" + Math.round(n).toLocaleString("en-US");
  const pct = (x) => Math.round(x * 100) + "%";
  const rint = (a, b) => Math.floor(Math.random() * (b - a + 1)) + a;
  const randNorm = () => {
    let u = 0, v = 0;
    while (u === 0) u = Math.random();
    while (v === 0) v = Math.random();
    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
  };

  // ---------- State ----------
  const state = {
    year: 1,
    playing: true,

    cash: 50000,
    expenses: 20000, // âœ… å¹´æ”¯å‡ºæ”¹ç‚º $20k
    burnout: 18,
    health: 85,

    stocks: 20000,
    stockMu: 0.08,
    stockSig: 0.16,
    lastStockR: 0,

    rpLevel: 0,
    sop: 0,
    rpRisk: 35,
    runners: 0,

    ciLevel: 0,
    library: 0,
    ciRisk: 25,

    rpCases: 0,
    rpMgmtRev: 0,
    rpContRev: 0,
    ciActive: 0,
    ciPassive: 0,

    sellChoice: 0,

    eventCooldown: {}, // âœ… äº‹ä»¶å†·å»è¨˜éŒ„

    log: [
      "æ­¡è¿ä¾†åˆ°ã€Šåå¹´é€€ä¼‘ã€‹â€” Runner å¹³å°è®Šé«”ï¼ˆä¿®æ­£ç‰ˆï¼‰ã€‚",
      "ä½ è¦åšçš„æ˜¯ï¼šç©©å®šä¸»æ¥­ç¾é‡‘æµ + ç´¯ç©å‰µä½œè³‡ç”¢ + é™ä½ Burnoutã€‚",
      "ç¬¬ 4 å¹´å¾Œå¯è³£ä¸»æ¥­è‚¡æ¬Šï¼ˆ10/20/30%ï¼‰å¥—ç¾ã€‚"
    ]
  };

  // ---------- UI ----------
  const $ = (id) => document.getElementById(id);
  const el = {
    yearPill: $("yearPill"), statusPill: $("statusPill"), runnerPill: $("runnerPill"),
    cashV: $("cashV"), expV: $("expV"), activeV: $("activeV"), passiveV: $("passiveV"),
    burnBar: $("burnBar"), burnV: $("burnV"),
    healthBar: $("healthBar"), healthV: $("healthV"),
    stocksV: $("stocksV"), stocksR: $("stocksR"),
    rpMeta: $("rpMeta"), rpCases: $("rpCases"), rpMgmt: $("rpMgmt"), rpCont: $("rpCont"), rpRates: $("rpRates"),
    ciMeta: $("ciMeta"), ciCF: $("ciCF"), ciP: $("ciP"), ciNotes: $("ciNotes"),
    eReg: $("eReg"), eCre: $("eCre"), eSys: $("eSys"),
    eRegLbl: $("eRegLbl"), eCreLbl: $("eCreLbl"), eSysLbl: $("eSysLbl"),
    cReg: $("cReg"), cCre: $("cCre"), cStk: $("cStk"),
    addRunner: $("addRunner"),
    mgmtFee: $("mgmtFee"), spots: $("spots"), initialFee: $("initialFee"), contShare: $("contShare"),
    sellNote: $("sellNote"),
    sell0: $("sell0"), sell10: $("sell10"), sell20: $("sell20"), sell30: $("sell30"),
    guardNote: $("guardNote"),
    log: $("log"),
    btnApply: $("btnApply"), btnNext: $("btnNext"), btnReset: $("btnReset"),
  };

  // ---------- Levels ----------
  function upgradeLevels() {
    const old = state.rpLevel;
    if (state.sop >= 25) state.rpLevel = Math.max(state.rpLevel, 1);
    if (state.sop >= 55) state.rpLevel = Math.max(state.rpLevel, 2);
    if (state.sop >= 80) state.rpLevel = Math.max(state.rpLevel, 3);

    const oldC = state.ciLevel;
    if (state.library >= 25) state.ciLevel = Math.max(state.ciLevel, 1);
    if (state.library >= 55) state.ciLevel = Math.max(state.ciLevel, 2);
    if (state.library >= 80) state.ciLevel = Math.max(state.ciLevel, 3);

    if (state.rpLevel !== old) state.log.push(`>>> ä¸»æ¥­å¹³å°å‡ç´šï¼šç­‰ç´š ${old} â†’ ${state.rpLevel}`);
    if (state.ciLevel !== oldC) state.log.push(`>>> å‰µä½œIPå‡ç´šï¼šç­‰ç´š ${oldC} â†’ ${state.ciLevel}`);
  }

  // ---------- Platform Flow ----------
  function calcPlatformFlow(inputs) {
    // âœ… Runner ç¡¬ä¸Šé™ 12
    const runners = Math.min(state.runners, 12);
    const spots = inputs.spots;
    const initialFee = inputs.initialFee;
    const mgmtFee = inputs.mgmtFee;

    const sop = state.sop;

    let closeRate = 0.22 + (sop/100)*0.30 + (inputs.eReg/100)*0.18 - (state.rpRisk/100)*0.08;
    closeRate = clamp(closeRate, 0.18, 0.68);

    let successRate = 0.55 + (sop/100)*0.22 + (inputs.eSys/100)*0.10 - (state.rpRisk/100)*0.05;
    successRate = clamp(successRate, 0.50, 0.88);

    // å¹³å‡ contingency / caseï¼ˆå«æ³¢å‹•ï¼‰
    let contPerCase = 3500 + successRate * 6500;
    const vol = 0.18 + (state.rpRisk / 100) * 0.20; // âœ… é¢¨éšªè¶Šé«˜æ³¢å‹•è¶Šå¤§
    contPerCase = contPerCase * (1 + (Math.random() * 2 - 1) * vol);
    contPerCase = clamp(contPerCase, 1800, 11000);

    const contShare = clamp(inputs.contShare, 0, 1);

    const levelBoost = [0.9, 1.0, 1.15, 1.25][state.rpLevel];

    // âœ… >6 Runner é–‹å§‹é‚Šéš›éæ¸›
    const diminishing = 1 / (1 + Math.max(0, runners - 6) * 0.12);
    const totalLeads = runners * spots * levelBoost * diminishing;

    // âœ… burnout/health æœƒæ‹–ä½æˆäº¤ï¼ˆéœ€æ±‚å´/åŸ·è¡Œå´ï¼‰
    const healthFactor = clamp(state.health / 100, 0.35, 1.0);
    const burnFactor = clamp(1 - state.burnout / 160, 0.55, 1.0);
    const execFactor = clamp(healthFactor * burnFactor, 0.30, 1.0);

    const cases = Math.floor(totalLeads * closeRate * execFactor);

    const initialFeeRev = cases * initialFee;
    const mgmtRev = runners * mgmtFee * 12;
    const contTotal = cases * contPerCase * contShare;

    const mgmtLoad = Math.floor(runners * 2.2);

    return {
      closeRate, successRate, contPerCase,
      totalLeads, cases,
      initialFeeRev, mgmtRev, contTotal,
      mgmtLoad,
      runnersUsed: runners
    };
  }

  // ---------- Creative Flow ----------
  function calcCreativeFlow(inputs) {
    const level = state.ciLevel;

    let base = ({0: 0, 1: 12000, 2: 38000, 3: 85000})[level];
    base = Math.floor(base * (level <= 1 ? 0.75 : 1.10));
    base += Math.floor((state.library/100) * 22000);

    // burnout/health äº¦æœƒå½±éŸ¿å‰µä½œåŸ·è¡Œ
    const exec = clamp((state.health/100) * (1 - state.burnout/170), 0.35, 1.0);
    base = Math.floor(base * exec);

    let passiveRatio = ({0:0.0, 1:0.18, 2:0.35, 3:0.55})[level] + (state.library/100)*0.12;
    passiveRatio = clamp(passiveRatio, 0, 0.75);
    const passive = Math.floor(base * passiveRatio);

    return { active: base, passive, passiveRatio };
  }

  // ---------- Stocks ----------
  function applyStockGrowth() {
    let r = state.stockMu + randNorm() * state.stockSig;
    r = clamp(r, -0.45, 0.60);
    state.stocks = Math.floor(state.stocks * (1 + r));
    state.lastStockR = r;
  }

  // ---------- Events ----------
  const EVENTS = [
    {
      name: "Partner è€åŒ– / é€€ä¼‘",
      desc: "ä¸»æ¥­ä¾è³´æŸå€‹åˆä½œæ–¹ï¼Œçªç„¶æ…¢ä¸‹ä¾†ã€‚",
      apply() {
        state.rpRisk = clamp(state.rpRisk + 8, 5, 95);
        state.cash -= 12000;
        state.burnout = clamp(state.burnout + 6, 0, 100);
        state.log.push("â€¢ é¢¨éšª +8ï¼Œç¾é‡‘ -12kï¼ŒBurnout +6");
      }
    },
    {
      name: "åˆè¦æŠ½æŸ¥",
      desc: "SOP å¼·â†’éé—œï¼›SOP å¼±â†’è£œæ´ã€‚",
      apply() {
        const q = state.sop;
        if (q >= 60) {
          state.cash += 15000;
          state.burnout = clamp(state.burnout - 4, 0, 100);
          state.log.push("â€¢ SOP éé—œï¼šç¾é‡‘ +15kï¼ŒBurnout -4");
        } else {
          state.cash -= 15000;
          state.burnout = clamp(state.burnout + 6, 0, 100);
          state.log.push("â€¢ SOP æœ‰æ´ï¼šç¾é‡‘ -15kï¼ŒBurnout +6");
        }
      }
    },
    {
      name: "Runner æµå¤±",
      desc: "ä¸€ä½ Runner åœç”¢æˆ–é›¢é–‹ã€‚",
      apply() {
        if (state.runners > 0) state.runners -= 1;
        state.cash -= 8000;
        state.burnout = clamp(state.burnout + 3, 0, 100);
        state.log.push("â€¢ Runner -1ï¼Œç¾é‡‘ -8kï¼ŒBurnout +3");
      }
    },
    {
      name: "AI å·¥å…·é™åƒ¹",
      desc: "ç³»çµ±åŒ–æ›´åˆ’ç®—ï¼Œæ›´æ˜“ SOP åŒ–ã€‚",
      apply() {
        state.sop = clamp(state.sop + 10, 0, 100);
        state.library = clamp(state.library + 6, 0, 100);
        state.burnout = clamp(state.burnout - 4, 0, 100);
        state.log.push("â€¢ SOP +10ï¼ŒLibrary +6ï¼ŒBurnout -4");
      }
    },
    {
      name: "å£ç¢‘çˆ†ç™¼",
      desc: "ä¸»æ¥­æˆäº¤ç‡æš«æ™‚ä¸Šå‡ï¼ˆä½†æœƒåŠ å£“ï¼‰ã€‚",
      apply() {
        state.cash += 18000;
        state.burnout = clamp(state.burnout + 4, 0, 100);
        state.log.push("â€¢ ç¾é‡‘ +18kï¼ŒBurnout +4");
      }
    },
    {
      name: "å¥åº·è­¦å ±",
      desc: "Burnout å¤ªé«˜ï¼Œèº«é«”æé†’ä½ ã€‚",
      apply() {
        state.health = clamp(state.health - 8, 0, 100);
        state.burnout = clamp(state.burnout + 5, 0, 100);
        state.log.push("â€¢ å¥åº· -8ï¼ŒBurnout +5");
      }
    }
  ];

  // âœ… äº‹ä»¶å†·å»ï¼ˆåŒäº‹ä»¶å…©å¹´å…§å””å†å‡ºï¼‰
  function maybeEvent() {
    if (state.year < 2) return;
    if (Math.random() > 0.75) return;

    const pool = EVENTS.filter(ev => {
      const last = state.eventCooldown[ev.name] ?? -999;
      return (state.year - last) >= 2;
    });

    const list = pool.length ? pool : EVENTS;
    const ev = list[rint(0, list.length - 1)];

    state.eventCooldown[ev.name] = state.year;

    state.log.push("");
    state.log.push("=== äº‹ä»¶ï¼š" + ev.name + " ===");
    state.log.push(ev.desc);
    ev.apply();
  }

  // ---------- Equity Sale ----------
  function impliedSellValuePlatform(annualEarnings) {
    const sopFactor = 0.2 + (state.sop/100)*0.8;
    const riskFactor = 1.0 - (state.rpRisk/100)*0.35;
    const baseLow = 3.0, baseHigh = 6.5;
    const mult = clamp(baseLow + (baseHigh - baseLow) * sopFactor * riskFactor, 3.0, 6.5);
    return Math.floor(annualEarnings * mult);
  }

  // ---------- Totals ----------
  function computeTotals(platform, creative) {
    const active = platform.initialFeeRev + platform.mgmtRev + creative.active;
    const safeWithdraw = Math.floor(state.stocks * 0.03);
    const passive = platform.contTotal + creative.passive + safeWithdraw;
    return { active, passive, safeWithdraw };
  }

  // ---------- Main Turn ----------
  function advanceYear() {
    if (!state.playing) return;

    // Inputs
    let eReg = parseInt(el.eReg.value, 10) || 0;
    let eCre = parseInt(el.eCre.value, 10) || 0;
    let eSys = parseInt(el.eSys.value, 10) || 0;

    // lock energy sum = 100
    let sum = eReg + eCre + eSys;
    if (sum !== 100) {
      eSys = clamp(100 - (eReg + eCre), 0, 100);
      el.eSys.value = String(eSys);
      sum = eReg + eCre + eSys;
      if (sum !== 100) {
        eCre = clamp(100 - (eReg + eSys), 0, 100);
        el.eCre.value = String(eCre);
      }
    }

    const inputs = {
      eReg, eCre, eSys,
      cReg: Math.max(0, parseInt(el.cReg.value, 10) || 0),
      cCre: Math.max(0, parseInt(el.cCre.value, 10) || 0),
      cStk: Math.max(0, parseInt(el.cStk.value, 10) || 0),
      addRunner: clamp(parseInt(el.addRunner.value, 10) || 0, 0, 3),
      mgmtFee: Math.max(0, parseInt(el.mgmtFee.value, 10) || 0),
      spots: clamp(parseInt(el.spots.value, 10) || 10, 1, 24),
      initialFee: Math.max(0, parseInt(el.initialFee.value, 10) || 0),
      contShare: clamp(parseFloat(el.contShare.value) || 0, 0, 1)
    };

    state.log.push("");
    state.log.push("---------------------------------------------------------------");
    state.log.push(`ç¬¬ ${state.year} å¹´`);
    state.log.push("---------------------------------------------------------------");

    // Event + Stocks
    maybeEvent();
    applyStockGrowth();
    state.log.push(`â€¢ è‚¡ç¥¨å›å ±ï¼š${pct(state.lastStockR)} â†’ ${money(state.stocks)}`);

    // Add runners (0â€“3), cap 12
    if (inputs.addRunner > 0) {
      let added = 0;
      for (let i=0; i<inputs.addRunner; i++) {
        if (state.runners >= 12) break;
        const p = 0.55 + (state.sop/100)*0.25 + (inputs.eSys/100)*0.15 - (state.rpRisk/100)*0.08;
        if (Math.random() < clamp(p, 0.35, 0.92)) added++;
      }
      state.runners = Math.min(12, state.runners + added);
      state.cash -= added * 1200;
      if (added > 0) state.log.push(`â€¢ æ–°å¢ Runnerï¼š+${added}ï¼ˆæ‹›å‹Ÿ/è¨“ç·´æˆæœ¬ï¼š${money(added*1200)}ï¼‰`);
      else if (state.runners >= 12) state.log.push("â€¢ Runner å·²æ»¿ 12 äººï¼ˆæœ¬å¹´ +0ï¼‰");
      else state.log.push("â€¢ æ‹›å‹Ÿ Runner å¤±æ•—ï¼ˆæœ¬å¹´ +0ï¼‰");
    }

    // Cash investments (keep 5k buffer)
    const buffer = 5000;
    let investTotal = inputs.cReg + inputs.cCre + inputs.cStk;
    const maxInvest = Math.max(0, state.cash - buffer);
    if (investTotal > maxInvest) {
      const scale = maxInvest / Math.max(1, investTotal);
      inputs.cReg = Math.floor(inputs.cReg * scale);
      inputs.cCre = Math.floor(inputs.cCre * scale);
      inputs.cStk = Math.floor(inputs.cStk * scale);
      investTotal = inputs.cReg + inputs.cCre + inputs.cStk;
      state.log.push(`â€¢ ç¾é‡‘æŠ•å…¥è¶…é¡â†’è‡ªå‹•ç¸®æ”¾ï¼ˆä¿ç•™ $5k bufferï¼‰`);
    }

    state.cash -= investTotal;
    state.stocks += inputs.cStk;

    // SOP & Library growth
    const sopGain = Math.floor(0.28 * inputs.eSys + 0.18 * inputs.eReg + 0.0007 * inputs.cReg);
    const libGain = Math.floor(0.30 * inputs.eCre + 0.0007 * inputs.cCre);
    state.sop = clamp(state.sop + sopGain, 0, 100);
    state.library = clamp(state.library + libGain, 0, 100);

    state.rpRisk = clamp(state.rpRisk - Math.floor(sopGain * 0.12) + rint(-2, 4), 5, 95);
    state.ciRisk = clamp(state.ciRisk - Math.floor(libGain * 0.08) + rint(-2, 3), 5, 95);

    upgradeLevels();

    // Compute flows
    const platform = calcPlatformFlow(inputs);
    const creative = calcCreativeFlow(inputs);
    const totals = computeTotals(platform, creative);

    state.rpCases = platform.cases;
    state.rpMgmtRev = platform.mgmtRev;
    state.rpContRev = platform.contTotal;
    state.ciActive = creative.active;
    state.ciPassive = creative.passive;

    // Burnout/Health (heavier)
    const rest = Math.max(0, inputs.eSys - 40); // âœ… eSys è¶…é40 è¦–ç‚ºä¼‘æ¯
    const baseBurn = 10 + platform.mgmtLoad + Math.floor((100 - inputs.eSys) * 0.03) - Math.floor(rest * 0.25);

    const sopRelief = Math.floor((state.sop/100) * 10);
    const creRelief = Math.floor((state.library/100) * 6);

    state.burnout = clamp(state.burnout + baseBurn - sopRelief - creRelief - 6, 0, 100);

    if (state.burnout >= 78) state.health = clamp(state.health - 10, 0, 100);
    else if (state.burnout <= 35) state.health = clamp(state.health + 2, 0, 100);

    if (rest > 0) {
      const heal = Math.floor(rest * 0.15);
      state.health = clamp(state.health + heal, 0, 100);
      state.log.push(`â€¢ ä¼‘æ¯å›å¾©ï¼šrest=${rest} â†’ Health +${heal}`);
    }

    // âœ… Burnout å´©ç›¤ï¼šæ‰ Runner
    if (state.burnout >= 90 && state.runners > 0) {
      const lost = Math.max(1, Math.floor(state.runners * 0.15));
      state.runners = Math.max(0, state.runners - lost);
      state.log.push(`â€¢ Burnout éé«˜ â†’ Runner æµå¤± ${lost} äººï¼ˆè‡ªå‹•ï¼‰`);
    }

    // âœ… ç”¢èƒ½ç½°å‰‡ï¼ˆæ›´é‡ï¼‰ï¼šBurnout + Health å…±åŒå½±éŸ¿
    let penalty = 1.0 - (state.burnout / 130);
    penalty *= clamp(state.health / 100, 0.35, 1.0);
    penalty = clamp(penalty, 0.25, 1.0);

    const activeEarned = Math.floor(totals.active * penalty);

    state.cash += activeEarned;
    state.cash -= state.expenses;
    state.cash += rint(-6000, 9000);

    // logs
    state.log.push(`â€¢ ä¸»æ¥­ï¼šRunner=${platform.runnersUsed}ï¼ŒLeads=${platform.totalLeads.toFixed(0)}ï¼ŒCases=${platform.cases}ï¼ŒClose=${pct(platform.closeRate)}ï¼ŒSuccess=${pct(platform.successRate)}`);
    state.log.push(`â€¢ ç®¡ç†è²»ï¼š${money(platform.mgmtRev)} /yrï¼›Contingencyï¼ˆä½ åˆ†æˆï¼‰ï¼š${money(platform.contTotal)} /yrï¼ˆæ³¢å‹•å·²å•Ÿç”¨ï¼‰`);
    state.log.push(`â€¢ å‰µä½œï¼šActive=${money(creative.active)} /yrï¼›Passive=${money(creative.passive)} /yr`);
    state.log.push(`â€¢ SOP +${sopGain} â†’ ${state.sop}/100ï¼›Library +${libGain} â†’ ${state.library}/100`);
    state.log.push(`â€¢ Burnout=${state.burnout}/100ï¼›Health=${state.health}/100ï¼›ç”¢èƒ½ç½°å‰‡â‰ˆ${pct(penalty)}`);
    state.log.push(`â€¢ ä¸»å‹•æ”¶å…¥ï¼š${money(totals.active)} Ã— ${pct(penalty)} â‰ˆ ${money(activeEarned)}`);
    state.log.push(`â€¢ è¢«å‹•æ”¶å…¥ï¼ˆcont + æˆæ¬Šé•·å°¾ + è‚¡ç¥¨3%ï¼‰ï¼š${money(totals.passive)}`);
    state.log.push(`â€¢ å¹´æœ«ç¾é‡‘ï¼š${money(state.cash)}`);

    // Equity sale (Year 4+)
    if (state.year >= 4 && state.sellChoice > 0) {
      const stableEarnings = Math.floor(platform.mgmtRev + platform.initialFeeRev);
      const implied = impliedSellValuePlatform(Math.max(1, stableEarnings));
      const proceeds = Math.floor(implied * (state.sellChoice / 100));
      state.cash += proceeds;

      // simplified post-sale impact
      state.runners = Math.floor(state.runners * (1 - state.sellChoice / 140));
      state.sop = clamp(Math.floor(state.sop * (1 - state.sellChoice / 200)), 0, 100);

      state.log.push(`â€¢ ã€è‚¡æ¬Šå‡ºå”®ã€‘è³£å‡º ${state.sellChoice}%ï¼šä¼°å€¼ç´„ ${money(implied)} â†’ å¥—ç¾ ${money(proceeds)}`);
      state.sellChoice = 0;
    }

    // Lose condition
    if (state.cash < -25000) {
      state.playing = false;
      state.log.push("");
      state.log.push("!!! ç ´ç”¢ï¼šç¾é‡‘è·Œç ´ -$25kï¼ˆæç¤ºï¼šä¿ç•™ bufferã€åŠ  SOPã€ä¸è¦éåº¦æ“´å¼µ Runnerï¼‰");
    }

    // Advance year / finish
    if (state.playing) state.year += 1;

    if (state.year > YEARS) {
      state.playing = false;

      state.log.push("");
      state.log.push("================================================================");
      state.log.push("éŠæˆ²çµæŸ â€” ç¬¬ 10 å¹´");
      state.log.push("================================================================");
      state.log.push(`ç¾é‡‘ï¼š${money(state.cash)}`);
      state.log.push(`è‚¡ç¥¨ï¼š${money(state.stocks)}`);
      state.log.push(`è¢«å‹•æ”¶å…¥ï¼ˆyrï¼‰ï¼š${money(totals.passive)}ï¼›å¹´æ”¯å‡ºï¼š${money(state.expenses)}`);
      state.log.push(`Burnoutï¼š${state.burnout}/100ï¼›Healthï¼š${state.health}/100`);

      if (totals.passive >= state.expenses && state.health >= 50) {
        state.log.push("");
        state.log.push("ğŸ æˆåŠŸé€€ä¼‘ï¼šè¢«å‹•æ”¶å…¥å·²è¦†è“‹æ”¯å‡ºï¼Œä¸”å¥åº·å°šå¯ã€‚");
      } else if (totals.passive >= state.expenses) {
        state.log.push("");
        state.log.push("âœ… è²¡å‹™ä¸Šé€€ä¼‘ï¼Œä½†å¥åº·/ç–²å‹è¦è™•ç†ï¼ˆå¦å‰‡é€€ä¼‘å“è³ªå·®ï¼‰ã€‚");
      } else {
        state.log.push("");
        state.log.push("â³ æœªé€€ä¼‘ï¼šä½ å·²å»ºç«‹è³‡ç”¢ï¼Œèª¿æ•´ç­–ç•¥å†ç©ä¸€å±€ã€‚");
      }
    }

    render();
  }

  // ---------- Render ----------
  function computeDisplayTotals() {
    const safeWithdraw = Math.floor(state.stocks * 0.03);
    const passive = state.rpContRev + state.ciPassive + safeWithdraw;
    const active = state.rpMgmtRev + state.ciActive;
    return { active, passive };
  }

  function render() {
    el.yearPill.textContent = `ç¬¬ ${Math.min(state.year, YEARS)} å¹´ / ${YEARS} å¹´`;
    el.statusPill.textContent = state.playing ? "é€²è¡Œä¸­" : "å·²çµæŸ";
    el.runnerPill.textContent = `Runnerï¼š${state.runners} äººï¼ˆä¸Šé™12ï¼‰`;

    el.cashV.textContent = money(state.cash);
    el.expV.textContent = money(state.expenses);

    const totals = computeDisplayTotals();
    el.activeV.textContent = money(totals.active);
    el.passiveV.textContent = money(totals.passive);

    el.burnBar.style.width = `${clamp(state.burnout, 0, 100)}%`;
    el.burnV.textContent = `${state.burnout}/100`;
    el.healthBar.style.width = `${clamp(state.health, 0, 100)}%`;
    el.healthV.textContent = `${state.health}/100`;

    el.stocksV.textContent = money(state.stocks);
    el.stocksR.textContent = `ä»Šå¹´å›å ±ï¼š${pct(state.lastStockR)}`;

    el.rpMeta.textContent = `ç­‰ç´š ${state.rpLevel} â€¢ SOP ${state.sop} â€¢ é¢¨éšª ${state.rpRisk}`;
    el.rpCases.textContent = String(state.rpCases);
    el.rpMgmt.textContent = money(state.rpMgmtRev);
    el.rpCont.textContent = money(state.rpContRev);
    el.rpRates.textContent = "ï¼ˆ>6 Runner é‚Šéš›éæ¸›ï¼›Burnout/Health æœƒæ‹–ä½æˆäº¤èˆ‡æ”¶å…¥ï¼›contingency æœ‰æ³¢å‹•ï¼‰";

    el.ciMeta.textContent = `ç­‰ç´š ${state.ciLevel} â€¢ Library ${state.library} â€¢ é¢¨éšª ${state.ciRisk}`;
    el.ciCF.textContent = money(state.ciActive);
    el.ciP.textContent = money(state.ciPassive);
    el.ciNotes.textContent = "ï¼ˆLibrary è¶Šé«˜ â†’ é•·å°¾æ¯”ä¾‹è¶Šé«˜ï¼›Burnout/Health æœƒæ‹–ä½å‰µä½œåŸ·è¡Œï¼‰";

    el.eRegLbl.textContent = el.eReg.value;
    el.eCreLbl.textContent = el.eCre.value;
    el.eSysLbl.textContent = el.eSys.value;

    el.sellNote.textContent = (state.year >= 4 && state.playing) ? `å·²é¸ï¼š${state.sellChoice}%` : "æœªé–‹æ”¾ï¼ˆç¬¬ 4 å¹´èµ·ï¼‰";

    el.btnApply.disabled = !state.playing;
    el.btnNext.disabled = !state.playing;

    el.log.textContent = state.log.slice(-260).join("\n");
  }

  // ---------- Reset ----------
  function reset() {
    state.year = 1;
    state.playing = true;

    state.cash = 50000;
    state.expenses = 20000; // âœ… reset ä¹Ÿæ”¹ $20k
    state.burnout = 18;
    state.health = 85;

    state.stocks = 20000;
    state.lastStockR = 0;

    state.rpLevel = 0;
    state.sop = 0;
    state.rpRisk = 35;
    state.runners = 0;

    state.ciLevel = 0;
    state.library = 0;
    state.ciRisk = 25;

    state.rpCases = 0;
    state.rpMgmtRev = 0;
    state.rpContRev = 0;
    state.ciActive = 0;
    state.ciPassive = 0;

    state.sellChoice = 0;
    state.eventCooldown = {};

    state.log = [
      "æ­¡è¿ä¾†åˆ°ã€Šåå¹´é€€ä¼‘ã€‹â€” Runner å¹³å°è®Šé«”ï¼ˆä¿®æ­£ç‰ˆï¼‰ã€‚",
      "ä½ è¦åšçš„æ˜¯ï¼šç©©å®šä¸»æ¥­ç¾é‡‘æµ + ç´¯ç©å‰µä½œè³‡ç”¢ + é™ä½ Burnoutã€‚",
      "ç¬¬ 4 å¹´å¾Œå¯è³£ä¸»æ¥­è‚¡æ¬Šï¼ˆ10/20/30%ï¼‰å¥—ç¾ã€‚"
    ];

    el.eReg.value = 55;
    el.eCre.value = 25;
    el.eSys.value = 20;

    el.cReg.value = 12000;
    el.cCre.value = 6000;
    el.cStk.value = 7000;
    el.addRunner.value = 1;

    el.mgmtFee.value = 400;
    el.spots.value = 10;
    el.initialFee.value = 1500;
    el.contShare.value = 0.33;

    render();
  }

  // ---------- Equity buttons ----------
  function setSellChoice(p) {
    if (state.year < 4 || !state.playing) return;
    state.sellChoice = p;
    render();
  }

  // ---------- Wire ----------
  el.btnApply.addEventListener("click", advanceYear);
  el.btnNext.addEventListener("click", advanceYear);
  el.btnReset.addEventListener("click", reset);

  function rebalanceEnergy(changed) {
    let a = parseInt(el.eReg.value, 10) || 0;
    let b = parseInt(el.eCre.value, 10) || 0;
    let c = parseInt(el.eSys.value, 10) || 0;

    if (changed === "reg" || changed === "cre") {
      c = clamp(100 - (a + b), 0, 100);
      el.eSys.value = String(c);
    } else if (changed === "sys") {
      b = clamp(100 - (a + c), 0, 100);
      el.eCre.value = String(b);
    }

    // final guard
    a = parseInt(el.eReg.value, 10) || 0;
    b = parseInt(el.eCre.value, 10) || 0;
    c = parseInt(el.eSys.value, 10) || 0;
    const sum = a + b + c;
    if (sum !== 100) {
      b = clamp(100 - (a + c), 0, 100);
      el.eCre.value = String(b);
    }

    render();
  }

  el.eReg.addEventListener("input", () => rebalanceEnergy("reg"));
  el.eCre.addEventListener("input", () => rebalanceEnergy("cre"));
  el.eSys.addEventListener("input", () => rebalanceEnergy("sys"));

  el.sell0.addEventListener("click", () => setSellChoice(0));
  el.sell10.addEventListener("click", () => setSellChoice(10));
  el.sell20.addEventListener("click", () => setSellChoice(20));
  el.sell30.addEventListener("click", () => setSellChoice(30));

  reset();
</script>
</body>
</html>
